<!DOCTYPE html>
<html>
<head>

<!-- <script src="https://static.robotwebtools.org/threejs/current/three.js"></script> -->

<script src="https://unpkg.com/three@0.119.0/build/three.js"></script>
 <script src="STLLoader.js"></script>

<!--<script src="https://static.robotwebtools.org/threejs/r89/ColladaLoader.js"></script>
<script src="https://static.robotwebtools.org/ros3djs/0.18.0/ColladaLoader.js"></script> -->
<script src="https://aframe.io/releases/1.0.4/aframe.js"></script>

<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.js"></script>
<script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>
<script src="ros3d.js"></script>

<!-- <script src="https://unpkg.com/aframe-input-mapping-component/dist/aframe-input-mapping-component.min.js"></script>
<script src="aframe-teleport-controls.js"></script>
<script src="common/mappings.js"></script> -->


<script>

 
  async function load_urdf(ros, tfClient, rootObjectScene,_callback){
     // Setup the URDF client.
     var urdfClient = new ROS3D.UrdfClient({
      ros : ros,
      tfClient : tfClient,
      path : 'https://192.168.2.110:8080/',
      // rootObject : viewer.scene
      rootObject : rootObjectScene
    });
    // await new Promise(r => setTimeout(r, 10000));
    _callback();
  }

	var viewer;
  /**
   * Setup all visualization elements when the page is loaded.
   */
  async function init_env() {
    var rootObjectScene = document.getElementById('robot-element-parent').object3D //  AFRAME.scenes[0].object3D // 
    var rootObjectNode = document.getElementById('robot-element-parent')
    // rootObjectScene.add(new ROS3D.Grid());
 
    // Connect to ROS.
    var ros = new ROSLIB.Ros({
      url : 'wss://192.168.2.110:9090'
    });


    // Setup a client to listen to TFs.
    var tfClient = new ROSLIB.TFClient({
      ros : ros,
      angularThres : 0.01,
      transThres : 0.01,
      rate : 10.0,
     fixedFrame: '/world' 
    });


//  var node = document.createElement("a-entity");   
//  node.setAttribute( "position","0 0 0")
//  rootObjectNode.appendChild(node) 
//  console.log(node)
//  console.log  (node.object3D)
  //Colorized cloud of the rotating laser scanner
  var cloudClient = new ROS3D.PointCloud2({
        ros: ros,
        tfClient: tfClient,
        topic: '/colored_cloud', 
        rootObject : document.getElementById('one').object3D,
        material: { size: 0.05},

    });
    // node = document.createElement("a-entity");   
    // node.setAttribute( "position","0 0 0")

//  rootObjectNode.appendChild(node) 
    // Point cloud of the rotating laser scanner
    var cloudClientOfLaserScanner = new ROS3D.PointCloud2({
        ros: ros,
        tfClient: tfClient,
        topic: '/scan_matched_points2', 
        rootObject :  document.getElementById('two').object3D,
        material: { size: 0.02, color: "rgb(123,45,125)"},

    });
    // node = document.createElement("a-entity");   
    // node.setAttribute( "position","0 0 0")

//  rootObjectNode.appendChild(node) 
    //Occupancy grid map used for navigation
    var gridClient = new ROS3D.OccupancyGridClient({
      ros : ros,
      topic: '/map',
      rootObject :  document.getElementById('three').object3D,
    });
    // node = document.createElement("a-entity");   
    // node.setAttribute( "position","0 0 0")

//  rootObjectNode.appendChild(node) 

    load_urdf(ros, tfClient,  document.getElementById('four').object3D,() => console.log('huzzah, I\'m done!'))

  
}

async function init_env_after_seconds(seconds){
  await new Promise(r => setTimeout(r, seconds*1000));
  init_env()

}
</script>
</head>

<body onload="init_env_after_seconds(1)">
  <a-scene  inspector="https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js"  id="main" >
  <a-entity id="rig" position="0 0 0">
    <a-entity id="camera" camera look-controls wasd-controls="acceleration:100" position="0 1.3 0"></a-entity>
    <!-- hand controls abstract 6dof controllers-->
    <a-entity teleport-controls="cameraRig: #rig"
              laser-controls="hand: left;">
    </a-entity>   
    <a-entity teleport-controls="type: line; cameraRig: #rig"
              laser-controls="hand: right;">                
    </a-entity>
  </a-entity>
  <a-entity  position="0 0 0" rotation="-90 0 0" id='robot-element-parent'>
    <a-entity  position="0 0 0" id='one'></a-entity>
    <a-entity  position="0 0 0" id='two'></a-entity>
    <a-entity  position="0 0 0" id='three'></a-entity>
    <a-entity  position="0 0 0" id='four'></a-entity>



  </a-entity>

	      <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
  
      <!-- <a-plane position="0 0 0" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
	 -->
</a-scene>
</body>
</html>

