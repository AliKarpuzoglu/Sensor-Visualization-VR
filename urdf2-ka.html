<!DOCTYPE html>
<html>
<head>

<!-- <script src="https://static.robotwebtools.org/threejs/current/three.js"></script> -->

<script src="https://unpkg.com/three@0.119.0/build/three.js"></script>
 <script src="STLLoader.js"></script>
<!--<script src="https://static.robotwebtools.org/threejs/r89/ColladaLoader.js"></script>
<script src="https://static.robotwebtools.org/ros3djs/0.18.0/ColladaLoader.js"></script> -->
<script src="https://aframe.io/releases/1.0.4/aframe.js"></script>

<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.js"></script>
<script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script>
<script src="ros3d.js"></script>

<script>
	var viewer;
  /**
   * Setup all visualization elements when the page is loaded.
   */
  async function init_env() {
    // Connect to ROS.
    var ros = new ROSLIB.Ros({
      url : 'wss://192.168.2.110:9090'
    });


    // Setup a client to listen to TFs.
    var tfClient = new ROSLIB.TFClient({
      ros : ros,
      angularThres : 0.01,
      transThres : 0.01,
      rate : 10.0,
     fixedFrame: '/world' 
    });



    this._floatColor = new Float32Array(1);
    this._rgb_lut = new Float32Array(256);
        for (var i = 0; i < 256; i++) {
        this._rgb_lut[i] = i / 255.0
        }        
        var that = this;
    colormapa = function(x) {
      that._floatColor[0] = x;
            const intColorArray = new Int32Array(that._floatColor.buffer);
            const intColor = intColorArray[0];

            return {
              r: that._rgb_lut[(intColor >> 16) & 0xff],
              g: that._rgb_lut[(intColor >> 8) & 0xff],
              b: that._rgb_lut[(intColor) & 0xff],
              a: 1.0
            };
          }
    //Colorized cloud of the rotating laser scanner
    var cloudClient = new ROS3D.PointCloud2({
        ros: ros,
        tfClient: tfClient,
        topic: '/colored_cloud', 
        rootObject : AFRAME.scenes[0].object3D,
        material: { size: 0.05},
        colormap:colormapa
       

    });
    // Point cloud of the rotating laser scanner
    var cloudClientOfLaserScanner = new ROS3D.PointCloud2({
        ros: ros,
        tfClient: tfClient,
        topic: '/scan_matched_points2', 
        rootObject : AFRAME.scenes[0].object3D,
        material: { size: 0.02, color: "rgb(123,45,125)"},

    });
    //Occupancy grid map used for navigation
    var gridClient = new ROS3D.OccupancyGridClient({
      ros : ros,
      topic: '/map',
      rootObject : AFRAME.scenes[0].object3D,
    });
    // Setup the URDF client.
    var urdfClient = new ROS3D.UrdfClient({
      ros : ros,
      tfClient : tfClient,
      path : 'https://192.168.2.110:8080/',
      // rootObject : viewer.scene
      rootObject : AFRAME.scenes[0].object3D
    });

    await new Promise(r => setTimeout(r, 2000));
    
    AFRAME.scenes[0].object3D.add(new ROS3D.Grid());


    // var pointCloud2 = new ROS3D.PoinCloud2({
    //   ros: ros,
    //   topic:''

    // })
    // console.log(urdfClient)
  // do{
      // var robot = urdfClient.that
      // console.log(urdfClient)

 setTimeout(function(){ 
   let scene_elements = AFRAME.scenes[0].object3D.children;
   scene_elements.forEach(element=>element.lookAt(0,1,0))

 
// var robot = scene_elements[scene_elements.length-1] //last element is the robot
// var grid = scene_elements[scene_elements.length-2] //last element is the robot

//  robot.lookAt(0,1,0); // make it look up
//  grid.lookAt(0,1,0)
},4000)

  };
 
</script>
</head>

<body onload="init_env()">
  <a-scene   id="main" >
	  <a-entity laser-controls="hand:left"></a-entity>
	  <a-entity laser-controls="hand:right"></a-entity>

	      <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
  
      <!-- <a-plane position="0 0 0" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>
	 -->
</a-scene>
</body>
</html>

